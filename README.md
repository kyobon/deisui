## 0. はじめに
- 本リポジトリにはWebアプリ「泥酔ストッパー」のソースコードが格納されています。
- 以下、「泥酔ストッパー」の利用方法及び技術情報を記載します。アプリの利用方法を知りたい方は1. アプリ説明を、アプリの裏側の仕組みを知りたい方は2. アプリの仕組みをご覧ください。
- アプリURL：
https://stop-deisui.com

## 1. アプリ説明
### 概要
- 「泥酔ストッパー」はお酒の飲み過ぎで失敗する人を減らすために、飲酒量の管理・アルコールの許容量を算出するためのアプリです。
- 飲酒量をカレンダーに記録していくことで、年月日単位でどれくらいの量のアルコールを摂取したのかが可視化されます。
- 飲酒した日の飲酒量と、その日の酔い具合から1回の飲み会あたりに飲んでいいお酒の量が算出されるため、飲み過ぎを防ぐことができます。

### 本アプリの作成理由
- 飲み会の席で酔いが回って楽しくなってしまい、つい不用意/デリカシーのない発言をして、翌日後悔するという日が多々あったので、これ以上は飲んではいけない、というラインを設けて、より飲み会の席を楽しみたいという思いがありました。また、周りにも飲み会中の発言を後から振り返って後悔する友人が多く、飲み会の席での失敗を減らしたいという思いは自分だけではなく色々な人も抱えているものだということがわかったので、本アプリを作ろうと思いました。
- 自分でせっかくアプリを作るのであれば、自分が使っていて楽しい/便利になるものを作りたいという思いが元々あったことも理由の一つとしてあります。

### 機能
#### カレンダー機能
- カレンダーにより、日別で飲酒量を記録することができます。
- ビール、ハイボール、酎ハイ、日本酒、ワイン、ウイスキー、焼酎に対応しています。
- 酔いの程度を「ほろ酔い」「酔っ払った」「ふらふらする/呂律が回らない」「泥酔」の四段階から選択し、その日の良い具合を記録できます。

#### 許容量算出
- 一度の飲み会で飲んでいいお酒の許容量が算出されます。
- 選択した飲み会の時間に応じて、許容量が測定されます。
- 許容量は、カレンダーの過去の飲酒記録のうち、酔いの程度を「ふらふらする/呂律が回らない」または「泥酔」に設定した日付の飲酒量から算出され、カレンダーの飲酒記録を増やせば増やすほど、許容量の正確性は向上します。
- 許容量からあなたのお酒の強さも判定します。

#### 飲酒データの表示
- 飲酒記録から当月分の飲酒量の推移がグラフ化されます。
- 平均アルコール摂取量、飲み過ぎ率、総泥酔回数などのデータも表示されます。

### デモ
#### ログイン後のページで、カレンダーへの飲酒記録の登録、編集、削除を実行


https://github.com/user-attachments/assets/d4750e7c-670a-4033-bf60-d5baf83ed035


#### 許容量の表示
※カレンダーに酔いの程度が「ふらふらする/呂律が回らない」または「泥酔」の日の記録がないと表示されないため注意。


https://github.com/user-attachments/assets/45aa919f-ed83-427f-8a61-d125e55f638f



## 2. アプリの仕組み
### 技術スタック
- フロントエンド：HTML、CSS、JavaScript
- バックエンド：Ruby on Rails
- インフラ：AWS（コンテナ基盤はFargate、DBはRDS PostgreSQL）
- IaC：CloudFormation
- CI/CD：GitHub Actions

### AWS構成図
![alcohol_構成図 drawio](https://github.com/user-attachments/assets/9809d438-a314-4df5-afce-a42b1771e5da)

### 許容量算出のロジック
人の酔いの具合は、血中アルコール濃度によって決まりますが、この血中アルコール濃度の計算方法としてウィドマーク法というものがあります。

https://www.ishiyaku.co.jp/corrigenda/731890/731890_01.pdf?2020060401

ウィドマーク法は、飲酒量、飲酒からの経過時間等のパラメータから血中アルコール濃度を算出するための手法であり、実際の飲酒運転の裁判等でも判決材料に利用されています。
本アプリで許容量を算出する際もこのウィドマーク法を用いています。
ウィドマーク法を用いると、血中アルコール濃度Ct(mg/ml)は以下の式で表されます。
```
C = A/(W×r)ー bt
  # C: 血中アルコール濃度(mg/ml)
  # t: アルコール摂取後の経過時間（h）
  # A: 摂取した純アルコール量（g）
  # W: 体重（kg）
  # r: 体内分布係数 
  # b: アルコール減少率
```
上記の式のうち、人の体に固有のパラメータはW、r、b の3つであるため、人の酒への耐性は3つのパラメータによって決定されます。
しかし、bのアルコール減少率については、個人差はあれど一般的に0.11〜0.19の間に収まるものであり、酒の強さの数値に対し支配的ではないため、0.15に固定して考えると、酒への耐性はW×rによって決定されます。
上記を踏まえてウィドマーク式を酒への耐性を表す式に変形すると、以下の通りになります。
```
(酒への耐性) ≒ W×r
           = A/(C+bt)
           = A/(C+0.15t)
```
上記の式より、酒への耐性はアルコール摂取量と摂取開始してからの経過時間とその時の血中アルコール濃度によって決まることがわかります。
血中アルコール濃度については自分自身で測定することはできませんが、酔いの程度と血中アルコール濃度は以下の通りにマッピングされます。
- 0.02～0.04：爽快期
- 0.05～0.10：ほろ酔い期
- 0.11～0.15：酩酊初期
- 0.16～0.30：酩酊極期
- 0.31～0.40：泥酔期
- 0.41～：昏睡期

参考リンク：
https://www.e-healthnet.mhlw.go.jp/information/dictionary/alcohol/ya-009.html

したがって、酒への耐性はアルコール摂取量と摂取開始してからの経過時間と酔いの程度から算出できるため、カレンダーに登録された飲酒記録のうち、酔いの程度が「ふらふらする/呂律が回らない」または「泥酔」に設定された日のアルコール摂取量と飲み会時間から、その人の酒への耐性を算出して、飲酒記録とともにデータベースに登録します。

そして、許容量Alimについては、過去の記録から算出された酒への耐性の値の平均値を再度ウィドマーク式に当てはめて、以下の通り算出されます。
なお、酒への耐性の値の平均値をTavgとし、許容量のアルコールをを摂取した時の血中アルコール濃度を酩酊極期の手前の0.15(mg/ml)としています。

```
Alim = Tavg × (0.15+0.15t)
```

